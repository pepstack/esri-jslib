/******************************************************************************
 * esri2.map.js
 *
 * Version: 0.0.1
 *
 * Copyright (c) 2011-2012 Esri
 *
 * All rights reserved under the copyright laws of the United States.
 * You may freely redistribute and use this software, with or
 * without modification, provided you include the original copyright
 * and use restrictions.  See use restrictions in the file:
 * <install location>/License.txt
 *
 * Last Date: 
 *****************************************************************************//**
 * esri2.map.js
 *   required: esri2.utility.js
 */
/**;
 * jslint browser: true,
 * onevar: true,
 * undef: true,
 * nomen: true,
 * bitwise: true,
 * regexp: true,
 * newcap: true,
 * immed: true,
 * strict: true,
 * global window: false,
 * jQuery: false,
 * console: false
 */
(function(a,b){"use strict";var c=!0,d=!1,e=null,f=-1,g=2,h=3,i=function(){};i.prototype={getAttributesCount:function(){var a=0,b;for(b in this.__map)++a;return a},getAttributeName:function(a){var b,c=0;for(b in this.__map)if(c++===a)return b;return null},getAttributeAt:function(a){var b,c=0;for(b in this.__map)if(c++===a)return this.__map[b]},getAttribute:function(a,b){var c=this.__map[a];if(c===null)return b;return c},addAttribute:function(a,b){if(__is_empty(a))return null;var c=this.__map[a];this.__map[a]=b;return c},removeAttribute:function(a){delete this.__map[a]},clearAttributes:function(){this.__map=null,this.__map={}}};var j=function(a,b){this._init(a,b)};j.prototype=new i,j.prototype._init=function(a,b){this.__map={},this.onImageLoad=a,this.param=b,this.readyCount=0},j.prototype.toString=function(){return"ImageLoader class"},j.prototype.addImage=function(a,b,c){__log("add image: ",a,"=>",b),this.addAttribute(a,new j.ImageState(a,b,this,c))},j.prototype.getImagesCount=function(){return this.getAttributesCount()},j.prototype.loadAll=function(){for(var a=0,b=this.getImagesCount(),c;a<b;a++)c=this.getAttributeAt(a),c._doLoad()},j.prototype.allReady=function(){return this.getImagesCount()==this.readyCount},j.prototype.getImageState=function(a){return this.getAttribute(a)},j.prototype.getImage=function(a){var b=this.getImageState(a);if(__not_null(b)&&b.ready)return b.image;return null},j.ImageState=function(a,b,c,d){this.name=a,this.ready=!1,this.imgSrc=b,this.param=d,this.loader=c,this.image=new Image},j.ImageState.prototype._doLoad=function(){this.image.addEventListener("load",j.ImageState.onReady(this),!1),this.image.src=this.imgSrc},j.ImageState.onReady=function(a){return function(){a.ready=!0,++a.loader.readyCount,__log("image loaded: ",a.name,"<=",a.imgSrc),__not_null(a.loader.onImageLoad)&&a.loader.onImageLoad(a)}};var k=function(a,b){this._init(a,b)};k.prototype={_init:function(a,b){this.name=a,this.tag=b,this.visible=!0,this.imageState=null},setImage:function(a,b,c,d){this.imageState=a,this.cx=b,this.cy=c,this.position=d},_draw:function(a,b,c){this.visible&&(__log("MapWidget._draw: ",this.name),this.position==="right-bottom"?a.drawImage(this.imageState.image,b-this.cx,c-this.cy):this.position==="left-top"&&a.drawImage(this.imageState.image,0,0))}};var l=function(a){this._init(a)};l.prototype=new i,l.eventDispatcher=function(a,b,c){__not_null(c)&&c(a,b)},l.prototype.getVersion=function(){return"0.0.1"},l.prototype.supportCanvas=function(){return __not_null(this.canvas)&&__not_null(this.__canvasContext)},l.prototype.item=function(a){var b=parseInt(a,10);if(isNaN(b)){var c=this.layers.find(a);return c===f?null:this.layers.getVal(c)}if(b>=0&&b<this.layers.size())return this.layers.getVal(b);throw new Error("MapCanvas: invalid layer index")},l.prototype.layerItem=function(a){var b=parseInt(a,10);if(isNaN(b)){var c=this.layers.find(a);return c===f?null:this.layers.getVal(c)}if(b>=0&&b<this.layers.size())return this.layers.getVal(b);throw new Error("MapCanvas: invalid layer index")},l.prototype.widgetItem=function(a){var b=parseInt(a,10);if(isNaN(b)){var c=this.widgets.find(a);return c===f?null:this.widgets.getVal(c)}if(b>=0&&b<this.widgets.size())return this.widgets.getVal(b);throw new Error("MapCanvas: invalid widget index")},l.prototype.addLayer=function(a,b){var c=new n(a,b);this.layers.insert(a,c);return c},l.prototype.addWidget=function(a,b){var c=new k(a,b);this.widgets.insert(a,c);return c},l.prototype.getDataBound=function(){var a=new m;a.createFromRect(this.__viewport.fullDataRect);return a},l.prototype.getViewDataBound=function(){var a=new m;a.createFromRect(this.__viewport.viewDataRect);return a},l.prototype.toMapPoint=function(a,b){return this.__viewport.vp2dp(a,b)},l.prototype.toViewPos=function(a,b){return this.__viewport.dp2vp(a,b)},l.prototype.resizeMap=function(a,b){if(a!=this.canvas.width||b!=this.canvas.height)this.canvas.width=a,this.canvas.height=b,this.__backend.width=this.canvas.width,this.__backend.height=this.canvas.height,this.__surface.width=this.canvas.width,this.__surface.height=this.canvas.height,this.__viewport.setViewRect(0,0,this.canvas.width,this.canvas.height)},l.prototype._drawWidgets=function(a,b,c){var d=parseInt(this.widgets.size(),10);while(d-->0)this.widgetItem(d)._draw(a,b,c)},l.prototype.eraseBkgnd=function(a){this.__surfaceContext.fillStyle=this.bkgndColor,this.__canvasContext.fillStyle=this.bkgndColor,__is_null(this.__bkgndPattern)&&(__not_null(this.__bkgndImageState)&&this.__bkgndImageState.ready&&(this.__bkgndPattern=this.__surfaceContext.createPattern(this.__bkgndImageState.image,"repeat"))),__not_null(this.__bkgndPattern)&&(this.__surfaceContext.fillStyle=this.__bkgndPattern,this.__canvasContext.fillStyle=this.__bkgndPattern),this.__surfaceContext.fillRect(0,0,this.canvas.width,this.canvas.height),this._drawWidgets(this.__surfaceContext,this.canvas.width,this.canvas.height);if(__is_null(a)||__is_true(a))this.__backendContext.fillStyle="#000000",this.__backendContext.fillRect(0,0,this.canvas.width,this.canvas.height)},l.prototype.updateBound=function(a){if(__not_null(a))this.__viewport.setDataRect(a.xmin,a.ymin,a.xmax,a.ymax);else{var b=this.layers.size();if(b>0){var c=this.item(0).bound.spawn();while(b-->1)c.union(this.item(b).bound);this.__viewport.setDataRect(c.xmin,c.ymin,c.xmax,c.ymax)}}},l.prototype.panView=function(a,b,c,d){this.__viewport.panViewPos(a,b,c,d)},l.prototype.zoomAll=function(a){this.__viewport.zoomAll(a)},l.prototype.zoomIn=function(a,b){this.__viewport.zoomAt(a,b,2)},l.prototype.zoomOut=function(a,b){this.__viewport.zoomAt(a,b,.5)},l.prototype.zoomExtent=function(a,b,c,d){__log("zoomExtent by MapPoint: ",a,b,c,d);var e=this.toViewPos(a,b),f=this.toViewPos(c,d);__log("zoomExtent by ViewPos: ",e.x,e.y,f.x,f.y),this.__viewport.zoomBox(e.x,e.y,f.x,f.y)},l.prototype.zoomResolution=function(a){this.__viewport.setResolution(a)},l.prototype.centerAt=function(a,b){var c=this.__viewport.dp2vp(a,b);this.__viewport.centerAt(c.x,c.y)},l.prototype.exportMap=function(a,b,c){var d=__is_empty(b)?this.canvas.width:b,e=__is_empty(c)?this.canvas.height:c;a.open(this.canvas.toDataURL(),this.__canvasID,"left=0,top=0,width="+d+",height="+e+",toolbar=0,resizable=0")},l.prototype.getPixelColor=function(a,b){var c=this.__canvasContext.getImageData(a,b,1,1).data,d=c[0]>>0,e=c[1]<<8,f=c[2]<<16,g=c[3]<<24;return d|e|f|g},l.prototype.refreshAll=function(){__log("MapCanvas.refreshAll()"),this.refresh(!0)},l.prototype.refresh=function(a,b){this.eraseBkgnd(a);var c=new y(this.__surface,this.__surfaceContext,this.__viewport);a&&c.saveBackend(this.__backend,this.__backendContext);var d=parseInt(this.layers.size(),10);if(d>0)while(d-->0)c.layerIndex=d,this.item(d)._draw(c),c.layerIndex=null;a&&c.restoreBackend(this.__backend,this.__backendContext),c.setDrawContext(this.canvas,this.__canvasContext),this.__canvasContext.drawImage(this.__surface,0,0),this.trackingLayer._draw(c)},l.prototype.refreshTrackingLayer=function(a){var b=new y(this.canvas,this.__canvasContext,this.__viewport);this.__canvasContext.drawImage(this.__surface,0,0),this.trackingLayer._draw(b)},l.prototype.panningCanvas=function(a,b,c,d){this.__canvasContext.fillRect(0,0,this.canvas.width,this.canvas.height),this.__canvasContext.drawImage(this.__surface,c-a,d-b)},l.prototype.fastHitTest=function(a,b,c){var d=this.__backendContext.getImageData(a,b,1,1).data;if(d[0]!==0){var e=new s(this);if(e.init(d[0]-1,d[1]-1,d[2]===0?null:d[2]-1)){__not_null(c)&&(__not_null(e.shape.eventHandler)&&e.shape.eventHandler(c,this,e.shape,e),__not_null(e.symbolShape)&&__not_null(e.symbolShape.eventHandler)&&e.symbolShape.eventHandler(c,this,e.symbolShape,e));return e}this.refreshAll()}return null},l.prototype.setCursor=function(a,b){__not_null(b)&&(b.preventDefault(),b.stopPropagation()),this.canvas.style.cursor=a},l.prototype.drawPoint_onClick=function(a,b){if(this.opState==="opDrawPoint"){__log("drawPoint_onClick");var c=this.getAttribute(this.opState+"Layer"),d=c.addShape(),e=this.toMapPoint(a,b);this.addAttribute("lastpoint",e),d.createPoint(e.x,e.y,e.z),d.symbol=this.getAttribute("$point"),c.updateBound(),this.refresh(!0,e)}},l.prototype.drawLine_onClick=function(a,b){if(this.opState==="opDrawLine"){__log("drawLine_onClick");var c=this.getAttribute(this.opState);__is_null(c)&&(c=this.trackingLayer.addShape(),c.createLine(),this.addAttribute(this.opState,c));var d=this.toMapPoint(a,b);c.points.push(d),c.updateBound(),this.refreshTrackingLayer(c)}},l.prototype.drawLine_onMouseMove=function(a,b){if(this.opState==="opDrawLine"){var c=this.getAttribute(this.opState);if(__not_null(c)&&c.points.length>0){var d=this.toMapPoint(a,b);c.points.push(d),c.updateBound(),this.refreshTrackingLayer(c),c.points.pop()}}},l.prototype.drawLine_onDblClick=function(a,b){if(this.opState==="opDrawLine"){__log("drawLine_onDblClick");var c=this.getAttribute(this.opState);this.removeAttribute(this.opState);if(__not_null(c)){this.trackingLayer.removeAt(c),this.trackingLayer.updateBound();if(c.valid){c.selectable=!0;var d=this.getAttribute(this.opState+"Layer");d.addShape(c),d.updateBound()}this.refresh(!0,c)}}},l.prototype.drawPolygon_onClick=function(a,b){if(this.opState==="opDrawPolygon"){__log("drawPolygon_onClick");var c=this.getAttribute(this.opState);__is_null(c)&&(c=this.trackingLayer.addShape(),c.createPolygon(),this.addAttribute(this.opState,c));var d=this.toMapPoint(a,b);c.points.push(d),c.updateBound(),this.refreshTrackingLayer(c)}},l.prototype.drawPolygon_onMouseMove=function(a,b){if(this.opState==="opDrawPolygon"){var c=this.getAttribute(this.opState);if(__not_null(c))if(c.points.length>=1){var d=this.toMapPoint(a,b);c.points.push(d),c.points.push(c.points[0]),c.updateBound(),this.refreshTrackingLayer(c),c.points.pop(),c.points.pop()}}},l.prototype.drawPolygon_onDblClick=function(a,b){if(this.opState==="opDrawPolygon"){__log("drawPolygon_onDblClick");var c=this.getAttribute(this.opState);this.removeAttribute(this.opState);if(__not_null(c)){this.trackingLayer.removeAt(c),this.trackingLayer.updateBound();if(c.points.length>=3){c.points.push(c.points[0]);if(c.valid){var d=this.getAttribute(this.opState+"Layer");c.selectable=!0,d.addShape(c),d.updateBound()}}this.refresh(!0,c)}}},l.prototype.drawRect_onClick=function(a,b){if(this.opState==="opDrawRect"||this.opState==="opZoomBox"){__log("drawRect_onClick");var c=this.getAttribute(this.opState);__is_null(c)&&(c=this.trackingLayer.addShape(),c.createRect(),this.addAttribute(this.opState,c));if(c.points.length<2){var d=this.toMapPoint(a,b);c.points.push(d),c.updateBound()}if(c.points.length===2){this.addAttribute(this.opState,null),this.trackingLayer.removeAt(c),this.trackingLayer.updateBound();if(this.opState==="opDrawRect"){var e=this.getAttribute(this.opState+"Layer");e.addShape(c),e.updateBound()}else{__log(this.opState);var f=c.points[0],g=c.points[1];this.zoomExtent(f.x,f.y,g.x,g.y)}this.refresh(!0,c)}}},l.prototype.drawRect_onMouseMove=function(a,b){if(this.opState==="opDrawRect"||this.opState==="opZoomBox"){__log("drawRect_onMouseMove");var c=this.getAttribute(this.opState);if(__not_null(c))if(c.points.length===1){var d=this.toMapPoint(a,b);c.points.push(d),c.updateBound(),this.refreshTrackingLayer(c),c.points.pop()}}},l.prototype._init=function(b){this.__map={};var c=this;this.__canvasID=b,this.canvas=__get_elem(this.__canvasID),this.__canvasContext=this.canvas.getContext("2d"),this.__viewport=new w(new v(0,0,this.canvas.width,this.canvas.height),new v(0,0,this.canvas.width,this.canvas.height),1);if(__is_null(this.canvas)||__is_null(this.__canvasContext))throw"MapCanvas: canvas 2d not supported.";this.__backend=document.createElement("canvas"),this.__backend.width=this.canvas.width,this.__backend.height=this.canvas.height,this.__backendContext=this.__backend.getContext("2d"),this.__surface=document.createElement("canvas"),this.__surface.width=this.canvas.width,this.__surface.height=this.canvas.height,this.__surfaceContext=this.__surface.getContext("2d"),Object.defineProperty(this,"width",{get:function(){return this.canvas.width},set:function(a){this.canvas.width=a}}),Object.defineProperty(this,"height",{get:function(){return this.canvas.height},set:function(a){this.canvas.height=a}}),this.opState="opNone",this.trackingLayer=new n("__tracking_layer__"),this.layers=new t,this.widgets=new t,this.bkgndColor="#FFFFFF",this.__bkgndPattern=this.__bkgndImageState=null,Object.defineProperty(this,"bkgndImage",{get:function(){return this.__bkgndImageState},set:function(a){this.__bkgndPattern=null,this.__bkgndImageState=a;try{__not_null(this.__bkgndImageState)&&this.__bkgndImageState.ready&&(this.__bkgndPattern=this.__canvasContext.createPattern(this.__bkgndImageState.image,"repeat"))}catch(b){this.__bkgndPattern=this.__bkgndImageState=null}}}),Object.defineProperty(this,"onKeyPressed",{set:function(b){a.addEventListener("keyup",function(a){l.eventDispatcher(a,c,b)},!0)}}),Object.defineProperty(this,"onMouseClick",{set:function(a){this.canvas.addEventListener("click",function(b){l.eventDispatcher(b,c,a),c.drawRect_onClick(b._x,b._y),c.drawPoint_onClick(b._x,b._y),c.drawLine_onClick(b._x,b._y),c.drawPolygon_onClick(b._x,b._y)},!1)}}),Object.defineProperty(this,"onMouseDblClick",{set:function(a){this.canvas.addEventListener("dblclick",function(b){l.eventDispatcher(b,c,a),c.drawLine_onDblClick(b._x,b._y),c.drawPolygon_onDblClick(b._x,b._y)},!1)}}),Object.defineProperty(this,"onMouseMove",{set:function(a){this.canvas.addEventListener("mousemove",function(b){l.eventDispatcher(b,c,a),c.drawRect_onMouseMove(b._x,b._y),c.drawLine_onMouseMove(b._x,b._y),c.drawPolygon_onMouseMove(b._x,b._y)},!1)}}),Object.defineProperty(this,"onMouseWheel",{set:function(a){this.canvas.addEventListener("mousewheel",function(b){l.eventDispatcher(b,c,a)},!1)}}),Object.defineProperty(this,"onMouseDown",{set:function(a){this.canvas.addEventListener("mousedown",function(b){l.eventDispatcher(b,c,a)},!1)}}),Object.defineProperty(this,"onMouseUp",{set:function(a){this.canvas.addEventListener("mouseup",function(b){l.eventDispatcher(b,c,a)},!1)}}),Object.defineProperty(this,"onMouseOver",{set:function(a){this.canvas.addEventListener("mouseover",function(b){l.eventDispatcher(b,c,a)},!1)}}),Object.defineProperty(this,"onMouseOut",{set:function(a){this.canvas.addEventListener("mouseout",function(b){l.eventDispatcher(b,c,a)},!1)}})};var m=function(a){this._init(a)};m.prototype._init=function(a){this.xmax=this.ymax=this.zmax=this.xmin=this.ymin=this.zmin=0,this.createFromPoints(a),Object.defineProperty(this,"valid",{get:function(){return this.xmax>=this.xmin&&this.ymax>=this.ymin&&this.zmax>=this.zmin}}),Object.defineProperty(this,"width",{get:function(){return this.xmax-this.xmin}}),Object.defineProperty(this,"height",{get:function(){return this.ymax-this.ymin}}),Object.defineProperty(this,"area",{get:function(){return this.width*this.height}}),Object.defineProperty(this,"length",{get:function(){return 2*(this.width+this.height)}}),Object.defineProperty(this,"rect",{get:function(){return new v(this.xmin,this.ymin,this.xmax,this.ymax)}})},m.prototype.toString=function(){return"MapBound class"},m.prototype.createFromPoints=function(a,b){if(__is_null(a)||a.length===0)this.clear();else{var c=a.length;__not_null(b)&&b<c&&(c=b);var d=1,e=a[0];for(this.xmin=this.xmax=e.x,this.ymin=this.ymax=e.y,this.zmin=this.zmax=e.z;d<c;d++)e=a[d],this.xmin>e.x&&(this.xmin=e.x),this.xmax<e.x&&(this.xmax=e.x),this.ymin>e.y&&(this.ymin=e.y),this.ymax<e.y&&(this.ymax=e.y),this.zmin>e.z&&(this.zmin=e.z),this.zmax<e.z&&(this.zmax=e.z)}},m.prototype.createFromRect=function(a){__not_null(a)&&(this.xmin=a.xmin,this.ymin=a.ymin,this.xmax=a.xmax,this.ymax=a.ymax)},m.prototype.clone=function(a){this.xmin=a.xmin,this.ymin=a.ymin,this.zmin=a.zmin,this.xmax=a.xmax,this.ymax=a.ymax,this.zmax=a.zmax},m.prototype.spawn=function(){var a=new m;a.clone(this);return a},m.prototype.clear=function(){this.xmax=this.ymax=this.zmax=this.xmin=this.ymin=this.zmin=0},m.prototype.offset=function(a,b,c){this.xmax+=a,this.ymax+=b,this.zmax+=__is_null(c)?0:c,this.xmin+=a,this.ymin+=b,this.zmin+=__is_null(c)?0:c},m.prototype.toXml=function(a){var b=__is_null(a)?g:a;return"<xmin>"+this.xmin.toFixed(b)+"</xmin><ymin>"+this.ymin.toFixed(b)+"</ymin><xmax>"+this.xmax.toFixed(b)+"</xmax><ymax>"+this.ymax.toFixed(b)+"</ymax><zmin>"+this.zmin.toFixed(b)+"</zmin><zmax>"+this.zmax.toFixed(b)+"</zmax>"},m.prototype.union=function(a){this.xmin=Math.min(this.xmin,a.xmin),this.ymin=Math.min(this.ymin,a.ymin),this.zmin=Math.min(this.zmin,a.zmin),this.xmax=Math.max(this.xmax,a.xmax),this.ymax=Math.max(this.ymax,a.ymax),this.zmax=Math.max(this.zmax,a.zmax)},m.prototype.toRectShape=function(){var a=new q;a.type="RECT",a.points[0]=new o(this.xmin,this.ymin,this.zmin),a.points[1]=new o(this.xmax,this.ymax,this.zmax),a.undateBound();return a};var n=function(a,b){this._init(a,b)};n.prototype=new i,n.prototype._init=function(a,b){this.__map={},this.name=a,this.tag=b,this.shapes=[],this.bound=new m,this.render=new p("__default__"),this.visible=!0,this.symbolMaxViewUnit=this.symbolMaxDataUnit=0},n.prototype.item=function(a){var b=parseInt(a,10);if(isNaN(b)||b<0||b>=this.shapes.length)throw"invalid index";return this.shapes[b]},n.prototype.findShapeIndex=function(a){var b=this.shapes.length;while(b-->0)if(this.shapes[b]===a)return b;return f},n.prototype.toString=function(){return"MapLayer class"},n.prototype.addShape=function(a){var b=__is_null(a)?new q:a;this.shapes.push(b),b.id=this.shapes.length,b._parentObj=this;return b},n.prototype.addShapeFront=function(a){var b=__is_null(a)?new q:a;this.shapes.unshift(b),b.id=this.shapes.length,b._parentObj=this;return b},n.prototype.addShapes=function(){for(var a=0,b=Array.prototype.slice.call(arguments),c=b.length;a<c;a++)this.addShape(b[a])},n.prototype.addShapesFront=function(){var a=Array.prototype.slice.call(arguments),b=a.length;while(b-->0)this.addShapeFront(a[b])},n.prototype.moveToFront=function(a){var b=this.removeAt(a);__not_null(b)&&this.addShapeFront(b)},n.prototype.moveToBack=function(a){var b=this.removeAt(a);__not_null(b)&&this.addShape(b)},n.prototype.removeAt=function(a){var b=parseInt(a,10),c=null;if(isNaN(b)){var d=this.shapes.length;while(d-->0)if(this.shapes[d]===a){c=this.shapes.splice(d,1),c._parentObj=null;return c}}else if(b>=0&&b<this.shapes.length){c=this.shapes.splice(b,1),c._parentObj=null;return c}return null},n.prototype.removeAll=function(){var a=this.shapes.length;while(a-->0)this.shapes[a]._parentObj=null;this.shapes.splice(0)},n.prototype.findShape=function(a,b){var c=this.shapes.length,d=b+"x";while(c-->0){var e=this.shapes[c];if(e.getAttribute(a,d)===b)return e}return null},n.prototype._updateSymbolMax=function(a,b){a.pixelUnit?this.symbolMaxViewUnit<b&&(this.symbolMaxViewUnit=b):this.symbolMaxDataUnit<b&&(this.symbolMaxDataUnit=b)},n.prototype.updateBound=function(){var a=this.shapes.length;a>0&&this.bound.clone(this.shapes[0].bound);while(a-->1)this.bound.union(this.shapes[a].bound)},n.prototype._isDraw=function(a){if(!this.visible)return!1;if(this.shapes.length===0)return!1;return!0},n.prototype._draw=function(a){if(this._isDraw(a)){for(var b=0,c=a.saveRender(this.render),d=parseInt(this.shapes.length,10);b<d;b++)a.shapeIndex=b,this.shapes[b]._draw(a),a.shapeIndex=null;a.restoreRender(this.render,c)}};var o=function(a,b,c){this._init(a,b,c)};o.prototype={_init:function(a,b,c){this.x=a,this.y=b,this.z=__is_null(c)?0:c},clear:function(){this.x=this.y=this.z=0},clone:function(a){this.x=a.x,this.y=a.y,this.z=a.z},spawn:function(){return new o(this.x,this.y,this.z)},distance:function(a){var b=this.x-a.x,c=this.y-a.y,d=this.z-a.z;return Math.sqrt(b*b+c*c+d*d)},same:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z},offset:function(a,b,c){this.x+=a,this.y+=b,this.z+=c},toString:function(){return"MapPoint class"},toXml:function(a){var b=__is_null(a)?g:a;return"<x>"+this.x.toFixed(b)+"</x><y>"+this.y.toFixed(b)+"</y><z>"+this.z.toFixed(b)+"</z>"}};var p=function(a,b){this._init(a,b)};p.prototype._init=function(a,b){this.name=a,this.tag=b,this.enabled=!0,this.globalAlpha=1,this.globalCompositeOperation="source-over",this.strokeStyle="#FF0000",this.fillStyle="#00FF00",this.fillImage=null,this.lineCap="square",this.lineJoin="miter",this.lineWidth=3,this.miterLimit=10,this.textStyle="#000",this.textAttrName=null,this.textAlign="left",this.textBaseline="top",this.fontStyle="normal",this.fontWeight="400",this.fontSize="10pt",this.fontFace="Times New Roman",this.radialGradient=this.linearGradient=null,this.shadowBlur=0,this.shadowColor="#000",this.shadowOffsetY=this.shadowOffsetX=0,Object.defineProperty(this,"font",{get:function(){return this.fontStyle+" "+this.fontWeight+" "+this.fontSize+" "+this.fontFace}})},p.prototype.validateProp=function(a){return __not_empty(a)&&a!="undefined"},p.prototype.setContext=function(a){a.textAlign=this.textAlign,a.textBaseline=this.textBaseline,a.lineCap=this.lineCap,a.lineJoin=this.lineJoin,a.lineWidth=this.lineWidth,a.miterLimit=this.miterLimit,a.font=this.font,a.globalAlpha=this.globalAlpha,a.globalCompositeOperation=this.globalCompositeOperation,this.validateProp(this.strokeStyle)&&(a.strokeStyle=this.strokeStyle),this.validateProp(this.fillStyle)&&(a.fillStyle=this.fillStyle),a.textAlign=this.textAlign,a.textBaseline=this.textBaseline,a.lineCap=this.lineCap,a.lineJoin=this.lineJoin,a.lineWidth=this.lineWidth,a.miterLimit=this.miterLimit,a.font=this.font,a.shadowBlur=this.shadowBlur,a.shadowColor=this.shadowColor,a.shadowOffsetX=this.shadowOffsetX,a.shadowOffsetY=this.shadowOffsetY},p.prototype.setStroke=function(a,b,c,d){this.strokeStyle=a,this.lineWidth=__not_null(b)?b:0,this.lineCap=__not_null(c)?c:"square",this.lineJoin=__not_null(d)?d:"miter"},p.prototype.setFill=function(a,b){this.fillStyle=a,this.fillImage=b},p.prototype.setText=function(a,b,c,d){this.textStyle=__not_null(a)?a:"#000",this.textAttrName=b,this.textAlign=__not_null(c)?c:"left",this.textBaseline=__not_null(d)?d:"top"},p.prototype.setFont=function(a,b,c,d){this.fontStyle=__not_null(a)?a:"normal",this.fontWeight=__not_null(b)?b:"400",this.fontSize=__not_null(c)?c:"10pt",this.fontFace=__not_null(d)?d:"Times New Roman"},p.prototype.setShadow=function(a,b,c,d){__not_null(a)?(this.shadowBlur=a,this.shadowColor=b,this.shadowOffsetX=c,this.shadowOffsetY=d):this.shadowOffsetY=this.shadowOffsetX=this.shadowBlur=0},p.prototype.setLinearGradient=function(){var a=Array.prototype.slice.call(arguments);if(a.length>2){this.linearGradient=new p.LinearGradient(a[0][0],a[0][1]);if(this.linearGradient.isValid())for(var b=1;b<a.length;b++)this.linearGradient.addColorStop(a[b][0],a[b][1])}},p.RadialGradient=function(){this._init()},p.RadialGradient.prototype._init=function(){},p.RadialGradient.prototype.addColorStop=function(a,b){},p.RadialGradient.prototype.isValid=function(){},p.RadialGradient.prototype.fillEnabled=function(){},p.RadialGradient.prototype.strokeEnabled=function(){},p.RadialGradient.prototype.createDrawStyle=function(a,b){},p.LinearGradient=function(a,b){this._init(a,b)},p.LinearGradient.Directions=["WE","EW","SN","NS","SWNE","NESW","NWSE","SENW"],p.LinearGradient.Styles=["fill","stroke","both"],p.LinearGradient.prototype._init=function(a,b){var c;for(this.style=-1,this.direction=-1,c=0;c<p.LinearGradient.Directions.length;c++)if(p.LinearGradient.Directions[c]===b){this.direction=c;break}for(c=0;c<p.LinearGradient.Styles.length;c++)if(p.LinearGradient.Styles[c]===a){this.style=c;break}this.colors={}},p.LinearGradient.prototype.addColorStop=function(a,b){this.colors[a]=b},p.LinearGradient.prototype.isValid=function(){return this.style!==-1&&this.direction!==-1},p.LinearGradient.prototype.fillEnabled=function(){return this.style===0||this.style===2},p.LinearGradient.prototype.strokeEnabled=function(){return this.style===1||this.style===2},p.LinearGradient.prototype.createDrawStyle=function(a,b){var c,d,e,f,g,h;switch(this.direction){case 0:e=b.xmin,f=b.ymin,g=b.xmax,h=b.ymin;break;case 1:e=b.xmax,f=b.ymin,g=b.xmin,h=b.ymin;break;case 2:e=b.xmin,f=b.ymax,g=b.xmin,h=b.ymin;break;case 3:g=b.xmin,h=b.ymax,e=b.xmin,f=b.ymin;break;case 4:e=b.xmin,f=b.ymax,g=b.xmax,h=b.ymin;break;case 5:g=b.xmin,h=b.ymax,e=b.xmax,f=b.ymin;break;case 6:e=b.xmin,f=b.ymin,g=b.xmax,h=b.ymax;break;case 7:g=b.xmin,h=b.ymin,e=b.xmax,f=b.ymax}d=a.createLinearGradient(e,f,g,h);for(c in this.colors)d.addColorStop(c,this.colors[c]);return d};var q=function(a){this._init(a)};q.prototype=new i,q.prototype._init=function(a){this.__map={},this.id=0,this.tag=a,this.points=[],this.bound=new m(this.points),this.type="NULL",this.visible=!0,this.selectable=!1,this.eventHandler=this.renderName=this.namedRenders=this.__symbol=this._parentObj=null,Object.defineProperty(this,"parent",{get:function(){return this._parentObj}}),Object.defineProperty(this,"symbol",{get:function(){return this.__symbol},set:function(a){__not_null(this.__symbol)&&(this.__symbol._parentObj=null),this.__symbol=a,__not_null(this.__symbol)&&(this.__symbol._parentObj=this)}}),Object.defineProperty(this,"avgPoint",{get:function(){var a=this.points.length,b=0,c=0,d=0,e,f;for(f=0;f<a;f++)e=this.points[f],b+=e.x,c+=e.y,d+=e.z;a===0&&(a=1);return new o(b/a,c/a,d/a)}}),Object.defineProperty(this,"area",{get:function(){switch(this.type){case"POLYGON":return __get_polygon_area__(this.points);case"CIRCLE":var a=this.points[0].distance(this.points[1]);return Math.PI*a*a;case"RECT":return(this.points[1].x-this.points[0].x)*(this.points[1].y-this.points[0].y)}return 0}}),Object.defineProperty(this,"length",{get:function(){switch(this.type){case"POLYGON":case"LINE":return __get_polyline_length__(this.points);case"CIRCLE":var a=this.points[0].distance(this.points[1]);return 2*Math.PI*a;case"ARC":return 0;case"RECT":return 2*(this.points[1].x-this.points[0].x+(this.points[1].y-this.points[0].y));case"CIRCLE3P":break;case"ARC3P":}return 0}}),Object.defineProperty(this,"valid",{get:function(){switch(this.type){case"POLYGON":return this.points.length>=4;case"LINE":return this.points.length>=2;case"RECT":case"CIRCLE":return this.points.length===2;case"ARC":case"CIRCLE3P":case"ARC3P":return this.points.length===3;case"ROUNDRECT":return this.points.length===4;case"POINT":return this.points.length>=1}return!1}})},q.prototype._updateCircleBound=function(){this.bound.clear();var a=this.points[0],b=this.points[1],c=a.distance(b),d=Math.abs(a.z-b.z);this.bound.xmin=a.x-c,this.bound.xmax=a.x+c,this.bound.ymin=a.y-c,this.bound.ymax=a.y+c,this.bound.zmin=a.z-d,this.bound.zmax=a.z+d},q.prototype._updateCircle3pBound=function(){},q.prototype._updateArc3pBound=function(){},q.prototype.updateBound=function(){switch(this.type){case"CIRCLE":this._updateCircleBound();break;case"ARC":this._updateArcBound();break;case"CIRCLE3P":this._updateCircle3pBound();break;case"ARC3P":this._updateArc3pBound();break;case"RECT":case"ROUNDRECT":this.bound.createFromPoints(this.points,2);break;default:this.bound.createFromPoints(this.points)}},q.prototype._getDrawRect=function(a,b){var c=__not_null(b)&&b.pixelUnit,d=c?this.bound.rect:a.viewport.drc2vrc(this.bound.rect);if(__not_null(this.symbol)){var e=this.symbol._getDrawRect(a);__not_null(e)&&(d.xmin+=e.xmin,d.ymin+=e.ymin,d.xmax+=e.xmax,d.ymax+=e.ymax)}else{var f=parseInt(a.context.lineWidth,10);isNaN(f)||d.inflate(f,f)}return d},q.prototype.createPoint=function(a,b,c){this.clearPoints(),this.type="POINT",this.points[0]=new o(a,b,c),this.updateBound()},q.prototype.createMultiPoints=function(a){this.clearPoints(),this.type="POINT";if(__not_null(a)){var b,c;for(c=0;c<a.length;c++)b=a[c],this.points[c]=new o(b.x,b.y,b.z);this.updateBound()}},q.prototype.createLine=function(a){this.clearPoints(),this.type="LINE";if(__not_null(a)){var b,c;for(c=0;c<a.length;c++)b=a[c],this.points[c]=new o(b.x,b.y,b.z);this.updateBound()}},q.prototype.createLineSeg=function(a,b){this.clearPoints(),this.type="LINE",__not_null(a)&&(this.points[0]=a,this.points[1]=b,this.updateBound())},q.prototype.createPolygon=function(a){this.clearPoints(),this.type="POLYGON";if(__not_null(a)){var b,c;for(c=0;c<a.length;c++)b=a[c],this.points[c]=new o(b.x,b.y,b.z);this.points[0].same(b)||this.points.push(this.points[0]),this.updateBound()}},q.prototype.createCircle=function(a,b){this.clearPoints(),this.type="CIRCLE",__not_null(a)&&(this.points[0]=new o(a.x,a.y,a.z),this.points[1]=new o(b.x,b.y,b.z),this._updateCircleBound())},q.prototype.createCircleXY=function(a,b,c){this.clearPoints(),this.type="CIRCLE",__not_null(a)&&(this.points[0]=new o(a,b,0),this.points[1]=new o(a+c,b,0),this._updateCircleBound())},q.prototype.createArc=function(a,b,c,d,e){this.clearPoints(),this.type="ARC",__not_null(a)&&(this.points[0]=new o(a.x,a.y,a.z),this.points[1]=new o(b.x,b.y,b.z),this.points[2]=new o(Math.PI*c/180,Math.PI*d/180,__is_null(e)||e?1:0),this._updateCircleBound())},q.prototype.createRect=function(a,b){this.clearPoints(),this.type="RECT",__not_null(a)&&(this.points[0]=new o(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.min(a.z,b.z)),this.points[1]=new o(Math.max(a.x,b.x),Math.max(a.y,b.y),Math.max(a.z,b.z)),this.updateBound())},q.prototype.createRectXY=function(a,b,c,d){this.clearPoints(),this.type="RECT",__not_null(a)&&(this.points[0]=new o(Math.min(a,c),Math.min(b,d),0),this.points[1]=new o(Math.max(a,c),Math.max(b,d),0),this.updateBound())},q.prototype.createRectXYZ=function(a,b,c,d,e,f){this.clearPoints(),this.type="RECT",__not_null(a)&&(this.points[0]=new o(Math.min(a,d),Math.min(b,e),Math.min(c,f)),this.points[1]=new o(Math.max(a,d),Math.max(b,e),Math.max(c,f)),this.updateBound())},q.prototype.createRoundRect=function(a,b,c,d,e,f){if(__is_null(c))return this.createRect(a,b);this.clearPoints(),this.type="ROUNDRECT";if(__not_null(a)){this.points[0]=new o(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.min(a.z,b.z)),this.points[1]=new o(Math.max(a.x,b.x),Math.max(a.y,b.y),Math.max(a.z,b.z)),this.updateBound();var g=__not_null(c)?c:0;this.points[2]=new o(g,__not_null(d)?d:g,0),this.points[3]=new o(__not_null(e)?e:g,__not_null(f)?f:g,0)}},q.prototype.createRoundRectXY=function(a,b,c,d,e,f,g,h){if(__is_null(e))return this.createRectXY(a,b,c,d);this.clearPoints(),this.type="ROUNDRECT";if(__not_null(a)){this.points[0]=new o(Math.min(a,c),Math.min(b,d),0),this.points[1]=new o(Math.max(a,c),Math.max(b,d),0),this.updateBound();var i=__not_null(e)?e:0;this.points[2]=new o(i,__not_null(f)?f:i,0),this.points[3]=new o(__not_null(g)?g:i,__not_null(h)?h:i,0)}},q.prototype.createBezier=function(a,b,c,d){this.clearPoints(),this.type="BEZIER",__not_null(a)&&(this.points[0]=new o(a.x,a.y,0),this.points[1]=new o(b.x,b.y,0),__is_null(c)||__is_null(d)?(this.points[2]=new o(b.x,a.y,0),this.points[3]=new o(a.x,b.y,0)):(this.points[2]=new o(c.x,c.y,0),this.points[3]=new o(d.x,d.y,0)),this.updateBound())},q.prototype.createCircle3p=function(a,b,c){this.clearPoints(),this.type="CIRCLE3P",!__not_null(a)},q.prototype.createArc3p=function(a,b,c){this.clearPoints(),this.type="ARC3P",!__not_null(a)},q.prototype.offset=function(a,b,c){if(this.type=="ARC")this.points[0].offset(a,b,c),this.points[1].offset(a,b,c);else for(var d,e=__is_null(c)?0:c,f=0;f<this.points.length;f++)d=this.points[f],d.x+=a,d.y+=b,d.z+=e;this.bound.offset(a,b,c)},q.prototype.getRect=function(a){},q.prototype._drawPoint=function(a,b,c){if(__not_null(this.symbol))this.symbol._draw(a,this);else{a.beginShape(this.selectable);var d=0,e=this.points.length;while(d<e){var f=a.toViewPos(this.points[d],b,c);a.context.moveTo(f.x-h,f.y),a.context.lineTo(f.x+h,f.y),a.context.moveTo(f.x,f.y-h-a.context.lineWidth/2),a.context.lineTo(f.x,f.y+h+a.context.lineWidth/2),++d}a.endShape()}},q.prototype._drawLine=function(a,b,c){var d=parseInt(this.points.length,10);if(d>=2){a.beginShape(this.selectable);var e=a.toViewPos(this.points[0],b,c);a.context.moveTo(e.x,e.y);var f=0;while(++f<d)e=a.toViewPos(this.points[f],b,c),a.context.lineTo(e.x,e.y);a.endShape()}},q.prototype._drawPolygon=function(a,b,c){var d=parseInt(this.points.length,10);if(d<4)this._drawLine(a,b,c);else{a.beginShape(this.selectable);var e=a.toViewPos(this.points[0],b,c);a.context.moveTo(e.x,e.y);var f=0;while(++f<d)e=a.toViewPos(this.points[f],b,c),a.context.lineTo(e.x,e.y);a.endShape()}},q.prototype._drawRect=function(a,b,c){if(this.points.length!==2)throw"MapShape._drawRect: points number error";a.beginShape(this.selectable);var d=a.toViewPos(this.points[0],b,c),e=a.toViewPos(this.points[1],b,c),f=new v(d.x,d.y,e.x,e.y),g=this.getAttribute(a.getTextAttrName());a.drawRect(f,g)},q.prototype._drawRoundRect=function(a,b,c){if(this.points.length!==4)throw"MapShape._drawRoundRect: points number error";a.beginShape(this.selectable);var d=a.toViewPos(this.points[0],b,c),e=a.toViewPos(this.points[1],b,c),f=a.toViewLength(this.points[2].x,c),g=a.toViewLength(this.points[2].y,c),h=a.toViewLength(this.points[3].x,c),i=a.toViewLength(this.points[3].y,c),j=new v(d.x,d.y,e.x,e.y);a.drawRoundRect(j,f,g,h,i)},q.prototype._drawCircle=function(a,b,c){if(this.points.length!==2)throw"MapShape._drawCircle: points number error";a.beginShape(this.selectable);var d=a.toViewPos(this.points[0],b,c),e=a.toViewPos(this.points[1],b,c),f=d.distance(e);a.drawCircle(d.x,d.y,f),a.endShape()},q.prototype._drawBezier=function(a,b,c){if(this.points.length!==4)throw"MapShape._drawBeizer: points number error";a.beginShape(this.selectable);var d=a.toViewPos(this.points[0],b,c),e=a.toViewPos(this.points[1],b,c),f=a.toViewPos(this.points[2],b,c),g=a.toViewPos(this.points[3],b,c);a.drawBezier(d,e,f,g),a.endShape()},q.prototype._drawCircle3p=function(a,b,c){if(this.points.length!==3)throw"MapShape._drawCircle: points number error";a.beginShape(this.selectable),a.endShape()},q.prototype._drawArc=function(a,b,c){if(this.points.length!==3)throw"MapShape._drawArc: points number error";a.beginShape(this.selectable);var d=a.toViewPos(this.points[0],b,c),e=a.toViewPos(this.points[1],b,c),f=d.distance(e),g=this.points[2].x,h=this.points[2].y,i=this.points[2].z>0?!0:!1;a.context.arc(d.x,d.y,f,g,h,i),a.endShape()},q.prototype._drawArc3p=function(a,b,c){if(this.points.length!==3)throw"MapShape._drawArc3p: points number error";a.beginShape(this.selectable),a.endShape()},q.prototype.__isDraw=function(a,b){if(this.type=="NULL"||!this.visible)return!1;if(__is_null(this.points)||this.points.length===0)return!1;if(__not_null(b))return!0;var c=this._getDrawRect(a),d=c.intersect(a.clipView);return d},q.prototype._draw=function(a,b,c){if(this.__isDraw(a,b))if(this.renderName==="__all__"&&this.getRendersCount()>0){var d=this.getRendersCount(),e;for(e=0;e<d;e++)this._drawByRender(a,this.namedRenders.getVal(e),b,c)}else this._drawByRender(a,this.currentRender(),b,c)},q.prototype._drawByRender=function(a,b,c,d){var e=a.saveRender(b);switch(this.type){case"POINT":this._drawPoint(a,c,d);break;case"LINE":this._drawLine(a,c,d);break;case"POLYGON":this._drawPolygon(a,c,d);break;case"RECT":this._drawRect(a,c,d);break;case"ROUNDRECT":this._drawRoundRect(a,c,d);break;case"CIRCLE":this._drawCircle(a,c,d);break;case"CIRCLE3P":this._drawCircle3p(a,c,d);break;case"ARC":this._drawArc(a,c,d);break;case"ARC3P":this._drawArc3p(a,c,d);break;case"BEZIER":this._drawBezier(a,c,d)}a.restoreRender(b,e)},q.prototype.toString=function(){return"MapShape Class"},q.prototype.getRendersCount=function(){if(__is_null(this.namedRenders))return 0;return this.namedRenders.size()},q.prototype.addRender=function(a,b){if(__is_empty(a))throw"MapShape.addRender: render must have a name";__is_null(this.namedRenders)&&(this.namedRenders=new t);var c=this.namedRenders.find(a);if(c===f){var d=new p(a,b);this.namedRenders.insert(d.name,d);return d}return this.namedRenders.getVal(c)},q.prototype.currentRender=function(){if(__is_null(this.namedRenders)||this.namedRenders.size()===0)return null;if(__is_null(this.renderName))return this.namedRenders.getVal(0);var a=this.namedRenders.find(this.renderName);if(a===f)return null;return this.namedRenders.getVal(a)},q.prototype.useDefaultRender=function(){this.renderName="__default__";return this.addRender(this.renderName)},q.prototype.useAllRender=function(){this.renderName="__all__"},q.prototype.item=function(a){return this.points[a]},q.prototype.clearPoints=function(){this.type="NULL",this.points=[],this.updateBound()},q.prototype.clone=function(a){this.clearPoints(),this.clearAttributes(),this.id=a.id,this.tag=a.tag,this.points=Array(a.points.length);var b;for(b=0;b<a.points.length;b++)this.points[b]=a.points[b].spawn();this.bound=a.bound.spawn(),this.type=a.type,this.visible=a.visible,this.selectable=a.selectable,this.namedRenders=a.namedRenders,this.renderName=a.renderName,this.symbol=a.symbol;var c=a.getAttributesCount();for(b=0;b<c;b++)this.addAttribute(a.attributes.getKey(b),a.attributes.getVal(b))},q.prototype.spawn=function(){var a=new q;a.clone(this);return a};var r=function(a,b){this._init(a,b)};r.UnitSys=function(a){this.pixelUnit=!0,this.scaleFactor=a,this.baseY=this.baseX=0},r.prototype=new i,r.prototype._init=function(a,b){this.__map={},this.name=a,this.tag=b,this.shapes=[],this.bound=new m,this.render=new p("__default__"),this.visible=!0,this.symbolMaxViewUnit=this.symbolMaxDataUnit=0,this.symbolUnit=new r.UnitSys(1),this._parentObj=null,Object.defineProperty(this,"parent",{get:function(){return this._parentObj}})},r.prototype.toString=function(){return"MapSymbol class"},r.prototype._getDrawRect=function(a){var b=this.shapes.length,c,d=null;while(b-->0)c=this.shapes[b],__is_null(d)?d=c._getDrawRect(a,this.symbolUnit):d.union(c._getDrawRect(a,this.symbolUnit));return d},r.prototype._isDraw=function(a,b){if(!this.visible)return!1;if(b.type!="POINT")throw"MapSymbol._isDraw: only point symbol supported";if(this.shapes.length===0)return!1;return!0},r.prototype._draw=function(a,b){if(this._isDraw(a,b)){for(var c=parseInt(b.points.length,10),d=parseInt(this.shapes.length,10),e=a.saveRender(this.render),f=0,g;f<c;f++){g=d;var h=b.points[f];while(g-->0)a.symbolShapeIndex=g,this.shapes[g]._draw(a,h,this.symbolUnit),a.symbolShapeIndex=null}a.restoreRender(this.render,e)}},r.prototype.item=function(a){var b=parseInt(a,10);if(isNaN(b)||b<0||b>=this.shapes.length)throw"invalid index";return this.shapes[b]},r.prototype.findShapeIndex=function(a){var b=this.shapes.length;while(b-->0)if(this.shapes[b]===a)return b;return f},r.prototype.addShape=function(a){var b=__is_null(a)?new q:a;this.shapes.push(b),b.id=this.shapes.length,b._parentObj=this;return b},r.prototype.addShapeFront=function(a){var b=__is_null(a)?new q:a;this.shapes.unshift(b),b.id=this.shapes.length,b._parentObj=this;return b},r.prototype.addShapes=function(){for(var a=0,b=Array.prototype.slice.call(arguments),c=b.length;a<c;a++)this.addShape(b[a])},r.prototype.addShapesFront=function(){var a=Array.prototype.slice.call(arguments),b=a.length;while(b-->0)this.addShapeFront(a[b])},r.prototype.removeAt=function(a){var b=parseInt(a,10),c=null;if(isNaN(b)){var d=this.shapes.length;while(d-->0)if(this.shapes[d]===a){c=this.shapes.splice(d,1),c._parentObj=null;return c}}else if(b>=0&&b<this.shapes.length){c=this.shapes.splice(b,1),c._parentObj=null;return c}return null},r.prototype.removeAll=function(){var a=this.shapes.length;while(a-->0)this.shapes[a]._parentObj=null;this.shapes.splice(0)},r.prototype.findShape=function(a,b){var c=this.shapes.length,d=b+"x";while(c-->0){var e=this.shapes[c];if(e.getAttribute(a,d)===b)return e}return null},r.prototype._updateSymbolMax=function(a,b){a.pixelUnit?this.symbolMaxViewUnit<b&&(this.symbolMaxViewUnit=b):this.symbolMaxDataUnit<b&&(this.symbolMaxDataUnit=b)},r.prototype.updateBound=function(){var a=this.shapes.length;a>0&&this.bound.clone(this.shapes[0].bound);while(a-->1)this.bound.union(this.shapes[a].bound)};var s=function(a){this.__init(a)};s.prototype.__init=function(a){this.mapCanvas=a,this.__symbolShape=this.__symbol=this.__shape=this.__layer=this.__symbolShapeIndex=this.__shapeIndex=this.__layerIndex=null,Object.defineProperty(this,"valid",{get:function(){if(__is_null(this.__layer)||__is_null(this.__shapeIndex)||__is_null(this.__shape))return!1;if(__is_null(this.__symbol))return!0;return __not_null(this.__symbolShapeIndex)&&__not_null(this.__symbolShape)}}),Object.defineProperty(this,"layer",{get:function(){return this.__layer}}),Object.defineProperty(this,"shape",{get:function(){return this.__shape}}),Object.defineProperty(this,"symbol",{get:function(){return this.__symbol}}),Object.defineProperty(this,"symbolShape",{get:function(){return this.__symbolShape}})},s.prototype.init=function(a,b,c){this.__layerIndex=a,__not_null(this.__layerIndex)&&(this.__layer=this.mapCanvas.item(this.__layerIndex)),__not_null(this.__layer)&&(this.__shapeIndex=b,__not_null(this.__shapeIndex)&&(this.__shape=this.__layer.shapes[this.__shapeIndex]),__not_null(this.__shape)&&(this.__symbolShapeIndex=c,__not_null(this.__symbolShapeIndex)&&(this.__symbol=this.__shape.symbol,__not_null(this.__symbol)&&(this.__symbolShape=this.__symbol.shapes[this.__symbolShapeIndex]))));return this.valid},s.prototype.toXml=function(){var a="<shapeTrace>\n";a+="  <layerIndex>"+this.__layerIndex+"</layerIndex>\n",a+="  <shapeIndex>"+this.__shapeIndex+"</shapeIndex>\n",this.__symbol!==null&&(a+="  <symbolName>"+this.__symbol.name+"</symbolName>\n",a+="  <symbolShapeIndex>"+this.__symbolShapeIndex+"</symbolShapeIndex>\n");return a+="</shapeTrace>"};var t=function(){this.__keymap={},this.__keys=[],this.__vals=[]};t.MaxSize=1e4,t.prototype={toString:function(){return"PairArray class"},genKey:function(){var a=this.size();if(this.find(a)===f)return a;a=0;while(a++<t.MaxSize)if(this.find(a)===f)return a;return null},find:function(a){var b=this.__keymap[a];return __is_null(b)?f:b},insert:function(a,b){var c=this.find(a);c===f?(this.__keymap[a]=this.__keys.length,this.__keys.push(a),this.__vals.push(b)):this.__vals[c]=b},size:function(){return this.__keys.length},getKey:function(a){return this.__keys[a]},getVal:function(a){return this.__vals[a]},setVal:function(a,b){this.__vals[a]=b},eraseAt:function(a){if(a>=0&&a<this.size()){var b,c,d=this.__keys[a];for(b in this.__keymap)c=this.__keymap[b],c>a&&(this.__keymap[b]=c-1);delete this.__keymap[d],this.__keys.splice(a,1);return this.__vals.splice(a,1)}return null},erase:function(a){return this.eraseAt(this.find(a))},clear:function(){this.__keymap=null,this.__keymap={},this.__keys.splice(0),this.__vals.splice(0)}};var u=function(a,b){this.x=a,this.y=b};u.prototype={toString:function(){return"PointType Class"},distance:function(a){return Math.sqrt((this.x-a.x)*(this.x-a.x)+(this.y-a.y)*(this.y-a.y))},distanceSq:function(a){return(this.x-a.x)*(this.x-a.x)+(this.y-a.y)*(this.y-a.y)},distanceGd:function(a){return Math.abs(this.x-a.x)+Math.abs(this.y-a.y)},offset:function(a,b){this.x+=a,this.y+=b},toXml:function(a){var b=__is_null(a)?3:a;return"<x>"+this.x.toFixed(b)+"</x><y>"+this.y.toFixed(b)+"</y>"},clone:function(a){this.x=a.x,this.y=a.y},spawn:function(){return new u(this.x,this.y)}};var v=function(a,b,c,d){this._init(a,b,c,d)};v.prototype._init=function(a,b,c,d){this.xmin=Math.min(a,c),this.ymin=Math.min(b,d),this.xmax=Math.max(a,c),this.ymax=Math.max(b,d),Object.defineProperty(this,"valid",{get:function(){return this.width>=0&&this.height>=0}}),Object.defineProperty(this,"width",{get:function(){return this.xmax-this.xmin}}),Object.defineProperty(this,"height",{get:function(){return this.ymax-this.ymin}}),Object.defineProperty(this,"area",{get:function(){if(!this.valid)return 0;return this.width*this.height}}),Object.defineProperty(this,"length",{get:function(){if(!this.valid)return 0;return 2*(this.width+this.height)}}),Object.defineProperty(this,"center",{get:function(){return new u((this.xmin+this.xmax)*.5,(this.ymin+this.ymax)*.5)}})},v.prototype.toString=function(){return"RectType class"},v.prototype.toXml=function(a){var b=__is_null(a)?g:a;return"<xmin>"+this.xmin.toFixed(b)+"</xmin><ymin>"+this.ymin.toFixed(b)+"</ymin><xmax>"+this.xmax.toFixed(b)+"</xmax><ymax>"+this.ymax.toFixed(b)+"</ymax>"},v.prototype.clone=function(a){this.xmin=a.xmin,this.ymin=a.ymin,this.xmax=a.xmax,this.ymax=a.ymax},v.prototype.clear=function(){this.ymax=this.xmax=this.ymin=this.xmin=0},v.prototype.offset=function(a,b){this.xmin+=a,this.xmax+=a,this.ymin+=b,this.ymax+=b},v.prototype.ptInRect=function(a,b){return a>=this.xmin&&a<this.xmax&&b>=this.ymin&&b<this.ymax},v.prototype.inflate=function(a,b){this.xmin-=Math.abs(a),this.xmax+=Math.abs(a),this.ymin-=Math.abs(b),this.ymax+=Math.abs(b)},v.prototype.intersect=function(a){this.xmin=Math.max(a.xmin,this.xmin),this.ymin=Math.max(a.ymin,this.ymin),this.xmax=Math.min(a.xmax,this.xmax),this.ymax=Math.min(a.ymax,this.ymax);return this.valid},v.prototype.union=function(a){this.xmin=Math.min(a.xmin,this.xmin),this.ymin=Math.min(a.ymin,this.ymin),this.xmax=Math.max(a.xmax,this.xmax),this.ymax=Math.max(a.ymax,this.ymax)},v.prototype.spawn=function(){return new v(this.xmin,this.ymin,this.xmax,this.ymax)};var w=function(a,b,c){this.__init(a,b,c)};w.prototype={__init:function(a,b,c){this.__MinScale=1e-7,this.__MaxScale=1e6,this.__viewRect=new v(a.xmin,a.ymin,a.xmax,a.ymax),this.__viewRect.width<1&&(this.__viewRect.xmax=this.__viewRect.xmin+1),this.__viewRect.height<1&&(this.__viewRect.ymax=this.__viewRect.ymin+1),this.__dataRect=new v(b.xmin,b.ymin,b.xmax,b.ymax),this.__dataRect.width<this.__MinScale&&(this.__dataRect.xmax=this.__dataRect.xmin+this.__MinScale),this.__dataRect.height<this.__MinScale&&(this.__dataRect.ymax=this.__dataRect.ymin+this.__MinScale),this.__ratio=__is_null(c)||c===0?1:c,this.__viewCP=this.__viewRect.center,this.__vdataCP=this.__dataRect.center,this.__scale=1,this.__setScale(this.__recalcScale()),Object.defineProperty(this,"viewRect",{get:function(){return this.__viewRect}}),Object.defineProperty(this,"fullDataRect",{get:function(){return this.__dataRect.spawn()}}),Object.defineProperty(this,"viewDataRect",{get:function(){var a=this.__viewRect.width/this.__scale*.5,b=this.__viewRect.height/this.__scale*.5;return new v(this.__vdataCP.x-a,this.__vdataCP.y-b,this.__vdataCP.x+a,this.__vdataCP.y+b)}})},__setScale:function(a){this.__scale=a<this.__MinScale?this.__MinScale:a>this.__MaxScale?this.__MaxScale:a},__recalcScale:function(){return Math.min(this.__viewRect.width/this.__dataRect.width,this.__viewRect.height/this.__dataRect.height)},init:function(a,b,c){this.__ratio=c,this.setViewRect(a.xmin,a.ymin,a.xmax,a.ymax),this.setDataRect(b.xmin,b.ymin,b.xmax,b.ymax)},setResolution:function(a){this.__setScale(1/a)},panView:function(a,b){this.__vdataCP.x-=a/this.__scale,this.__vdataCP.y+=b/this.__scale},panViewPos:function(a,b,c,d){this.panView(c-a,d-b)},setViewRect:function(a,b,c,d){this.__viewRect=new v(a,b,c,d),this.__viewCP=this.__viewRect.center},setDataRect:function(a,b,c,d){this.__dataRect=new v(a,b,c,d),this.__vdataCP=this.__dataRect.center,this.__setScale(this.__recalcScale())},zoomAt:function(a,b,c){var d=this.vp2dp(a,b);this.zoom(c);var e=this.dp2vp(d.x,d.y);this.panView(a-e.x,b-e.y)},zoomBox:function(a,b,c,d){var e=99.9999,f=((a-c)*e).toFixed(0),g=(Math.abs(b-d)*e).toFixed(0);this.centerAt((a+c)*.5,(b+d)*.5),f<0?this.__setScale(this.__scale*Math.min(-this.__viewRect.width*e/f,this.__viewRect.height*e/g)):f>0&&this.__setScale(this.__scale*Math.min(f/this.__viewRect.width/e,g/this.__viewRect.height/e))},panViewData:function(a,b){this.__vdataCP.x+=a,this.__vdataCP.y+=b},centerAt:function(a,b){this.__vdataCP=this.vp2dp(a,b)},zoom:function(a){__is_null(a)&&(a=1),this.__setScale(this.__scale*Math.abs(a))},zoomCenter:function(a){__is_null(a)&&(a=1),this.__setScale(this.__scale*Math.abs(a)),this.__vdataCP=this.__dataRect.center},zoomAll:function(a){__is_null(a)&&(a=1),this.__vdataCP=this.__dataRect.center,this.__setScale(a*this.__recalcScale())},dp2vp:function(a,b){a-=this.__vdataCP.x,b-=this.__vdataCP.y;return new u(Math.round(this.__viewCP.x+this.__scale*a),Math.round((this.__viewCP.y-this.__scale*b)/this.__ratio))},dp2vp_n:function(a){var b=a.length,c=Array(b),d;while(b-->0)d=a[b],c[b]=this.dp2vp(d.x,d.y);return c},vp2dp:function(a,b){return new u(this.__vdataCP.x+(a-this.__viewCP.x)/this.__scale,this.__vdataCP.y-(b*this.__ratio-this.__viewCP.y)/this.__scale)},vp2dp_n:function(a){var b=a.length,c=Array(b),d;while(b-->0)d=a[b],c[b]=this.vp2dp(d.x,d.y);return c},vl2dl:function(a){return a/this.__scale},dl2vl:function(a){return a*this.__scale},drc2vrc:function(a){var b=this.dp2vp(a.xmin,a.ymax),c=this.dp2vp(a.xmax,a.ymin);return new v(b.x,b.y,c.x,c.y)},vrc2drc:function(a){var b=this.vp2dp(a.xmin,a.ymax),c=this.vp2dp(a.xmax,a.ymin);return new v(b.x,b.y,c.x,c.y)}};var x=function(){};x.drawPoint=function(a,b,c,d,e){if(d>1){var f,g,h=Math.floor(d/2);for(f=b-h;f<b+h+1;f++)for(g=c-h;g<c+h+1;g++)a.setPixel(f,g,e)}else a.setPixel(b,c,e)},x.fillRect=function(a,b,c,d,e,f){var g=Math.min(b,d),h=Math.min(c,e),i=Math.max(b,d),j=Math.max(c,e),k,l;for(k=g;k<i;k++)for(l=h;l<j;l++)a.setPixel(k,l,f)},x.strokeRect=function(a,b,c,d,e,f,g){x.drawLine(a,b,c,b,e,f,g),x.drawLine(a,b,e,d,e,f,g),x.drawLine(a,d,e,d,c,f,g),x.drawLine(a,d,c,b,c,f,g)},x.drawLine=function(a,b,c,d,e,f,g){b=Math.floor(b+.5),c=Math.floor(c+.5),d=Math.floor(d+.5),e=Math.floor(e+.5);var h=Math.abs(d-b),i=Math.abs(e-c),j=0,k;h<i&&(j=1,k=b,b=c,c=k,k=d,d=e,e=k,k=h,h=i,i=k);var l=d-b>0?1:-1,m=e-c>0?1:-1,n=b,o=c,p=i*2,q=(i-h)*2,r=i*2-h;if(j==1)while(n!=d)r<0?r+=p:(o+=m,r+=q),x.drawPoint(a,o,n,f,g),n+=l;else while(n!=d)r<0?r+=p:(o+=m,r+=q),x.drawPoint(a,n,o,f,g),n+=l},x.drawCubicBezier=function(a,b,c,d,e,f,g,h,i,j,k){for(var l=Math.abs(h-b)+Math.abs(i-c),m=1/(l+1),n=m,o=b,p=c,q,r,s=function(){return function(a,b,c,d,e){return a*(1-e)*(1-e)*(1-e)+3*b*e*(1-e)*(1-e)+3*c*e*e*(1-e)+d*e*e*e}}();n<1;n+=m)q=s(b,d,f,h,n),r=s(c,e,g,i,n),Math.abs(q-o)+Math.abs(r-p)>=1&&(x.drawPoint(a,o,p,j,k),o=q,p=r);x.drawPoint(a,h,i,j,k)},x.fillCircle=function(a,b,c,d,e){var f=0,g=d,h,i=3-2*d;while(f<=g){for(h=f;h<=g;h++)a._set_circle_8(b,c,f,h,e);i<0?i=i+4*f+6:(i=i+4*(f-g),--g),++f}},x.strokeCircle=function(a,b,c,d,e,f){var g=0,h=d,i=3-2*d;while(g<=h)a._set_circle_8_w(b,c,g,h,f,e),i<0?i=i+4*g+6:(i=i+4*(g-h),--h),++g},x.DrawContext=function(a,b,c,d){this._init(a,b,c)},x.DrawContext.prototype={_init:function(a,c,d,e){this._pa=a,this._cx=c,this._cy=d,this._alpha=e===null||e===b?!1:e},_setRGB:function(a,b,c,d,e){a>=0&&a<this._cx&&b>=0&&b<this._cy&&(b=(b*this._cx+a)*4,this._pa[b]=c,this._pa[b+1]=d,this._pa[b+2]=e)},_setRGBA:function(a,b,c,d,e,f){a>=0&&a<this._cx&&b>=0&&b<this._cy&&(b=(b*this._cx+a)*4,this._pa[b]=c,this._pa[b+1]=d,this._pa[b+2]=e,this._pa[b+3]=f)},_get:function(a,b){var c=[];if(a>=0&&a<this._cx&&b>=0&&b<this._cy){b=(b*this._cx+a)*4,c.push(this._pa[b]),c.push(this._pa[b+1]),c.push(this._pa[b+2]),this._alpha&&c.push(this._pa[b+3]);return c}return null},_set_circle_8:function(a,b,c,d,e){this.setPixel(a+c,b+d,e),this.setPixel(a-c,b+d,e),this.setPixel(a+c,b-d,e),this.setPixel(a-c,b-d,e),this.setPixel(a+d,b+c,e),this.setPixel(a-d,b+c,e),this.setPixel(a+d,b-c,e),this.setPixel(a-d,b-c,e)},_set_circle_8_w:function(a,b,c,d,e,f){var g=Math.floor(f/2);if(g<1)return this._set_circle_8(a,b,c,d,e);var h,i;for(h=a-g;h<a+g+1;h++)for(i=b-g;i<b+g+1;i++)this._set_circle_8(h,i,c,d,e)},getPixel:function(a,b){a=Math.floor(a+.5),b=Math.floor(a+.5);return this._get(a,b)},setPixel:function(a,b,c){a=Math.floor(a+.5),b=Math.floor(b+.5),this._alpha?this._setRGBA(a,b,c[0],c[1],c[2],c[3]):this._setRGB(a,b,c[0],c[1],c[2])}};var y=function(a,b,c){this.__init(a,b,c)};y.prototype={__init:function(a,b,c){this.canvas=a,this.context=b,this.viewport=c,this.clipView=new v(0,0,this.canvas.width,this.canvas.height),this.clipData=this.viewport.viewDataRect,this.symbolShapeIndex=this.shapeIndex=this.layerIndex=null,this.__renders=[],this.__current=null,this.__selectable=!1,this.__backendData=this.__backendImage=this.__backendContext=this.__backend=null},fillEnabled:function(){return __not_null(this.__current)&&this.__current.validateProp(this.__current.fillStyle)},strokeEnabled:function(){return __not_null(this.__current)&&this.__current.validateProp(this.__current.strokeStyle)},linearGradientEnabled:function(a){if(__is_null(this.__current)||__is_null(this.__current.linearGradient))return!1;if(!this.__current.linearGradient.isValid())return!1;if(__is_null(a))return!0;return this.__current.linearGradient.style===2||this.__current.linearGradient.style===a},getRGBA:function(){var a=[this.layerIndex+1,this.shapeIndex+1,__is_null(this.symbolShapeIndex)?0:this.symbolShapeIndex+1,0];return a},__validRender:function(a){return __not_null(this.context)&&__not_null(a)&&a.enabled},saveBackend:function(a,b){this.__backend=a,this.__backendContext=b,this.__backendImage=this.__backendContext.getImageData(0,0,this.canvas.width,this.canvas.height),this.__backendData=this.__backendImage.data,this.__bresenhamDC=new x.DrawContext(this.__backendData,this.canvas.width,this.canvas.height,!1)},restoreBackend:function(){this.__backendContext.putImageData(this.__backendImage,0,0),this.__backendData=this.__backendImage=null},setDrawContext:function(a,b){this.canvas=a,this.context=b},getTextAttrName:function(){return __not_null(this.__current)&&this.__current.validateProp(this.__current.textAttrName)?this.__current.textAttrName:null},saveRender:function(a){if(this.__validRender(a))if(this.__current!==a){this.__current=a,this.__renders.push(this.__current),this.context.save(),this.__current.setContext(this.context);return!0}return!1},restoreRender:function(a,b){if(b){this._saved=!1;var c=this.__renders.pop();if(this.__current!==c)throw"DrawInfo.restore: illegal usage of this object";var d=this.__renders.length;this.__current=d===0?null:this.__renders[d-1],this.context.restore()}},toViewPos:function(a,b,c){if(__is_null(b))return this.viewport.dp2vp(a.x,a.y);if(__is_null(c)||!c.pixelUnit)return this.viewport.dp2vp(a.x+b.x,a.y+b.y);var d=this.viewport.dp2vp(b.x,b.y);d.offset(a.x-c.baseX,a.y-c.baseY);return d},toViewLength:function(a,b){return __is_null(b)||!b.pixelUnit?this.viewport.dl2vl(a):a},beginShape:function(a){this.__selectable=__not_null(this.__backendData)&&a===!0,this.context.beginPath()},endShape:function(){this.fillEnabled()&&this.context.fill(),this.strokeEnabled()&&this.context.stroke()},drawRoundRect:function(a,b,c,d,e){this.context.beginPath(),this.context.moveTo(a.xmin+b,a.ymin),this.context.lineTo(a.xmax-c,a.ymin),c>0&&this.context.arc(a.xmax-c,a.ymin+c,c,Math.PI*1.5,Math.PI*2,!1),this.context.lineTo(a.xmax,a.ymax-d),d>0&&this.context.arc(a.xmax-d,a.ymax-d,d,0,Math.PI/2,!1),this.context.lineTo(a.xmin+e,a.ymax),e>0&&this.context.arc(a.xmin+e,a.ymax-e,e,Math.PI/2,Math.PI,!1),this.context.lineTo(a.xmin,a.ymin+b),b>0&&this.context.arc(a.xmin+b,a.ymin+b,b,Math.PI,Math.PI*1.5,!1),this.context.closePath();var f,g=this.linearGradientEnabled()?this.__current.linearGradient.createDrawStyle(this.context,a):null;__not_null(g)&&this.__current.linearGradient.fillEnabled()?(f=this.context.fillStyle,this.context.fillStyle=g,this.context.fill(),this.context.fillStyle=f):this.fillEnabled()&&this.context.fill(),__not_null(g)&&this.__current.linearGradient.strokeEnabled()?(f=this.context.strokeStyle,this.context.strokeStyle=g,this.context.stroke(),this.context.strokeStyle=f):this.strokeEnabled()&&this.context.stroke();if(this.__selectable){var h=this.getRGBA();(this.fillEnabled()||this.linearGradientEnabled(0)||__not_null(this.__current.fillImage))&&x.fillRect(this.__bresenhamDC,a.xmin,a.ymin,a.xmax,a.ymax,h),(this.strokeEnabled()||this.linearGradientEnabled(1))&&x.strokeRect(this.__bresenhamDC,a.xmin,a.ymin,a.xmax,a.ymax,this.context.lineWidth,h)}},drawCircle:function(a,b,c){this.context.arc(a,b,c,0,Math.PI*2,!0);if(this.__selectable){var d=this.getRGBA();this.fillEnabled()&&x.fillCircle(this.__bresenhamDC,a,b,c,d),this.strokeEnabled()&&x.strokeCircle(this.__bresenhamDC,a,b,c,this.context.lineWidth,d)}},drawBezier:function(a,b,c,d){this.context.moveTo(a.x,a.y),this.context.bezierCurveTo(c.x,c.y,d.x,d.y,b.x,b.y),this.__selectable&&x.drawCubicBezier(this.__bresenhamDC,a.x,a.y,c.x,c.y,d.x,d.y,b.x,b.y,this.context.lineWidth+2,this.getRGBA())},drawRect:function(a,b){var c,d=this.linearGradientEnabled()?this.__current.linearGradient.createDrawStyle(this.context,a):null;__not_null(d)&&this.__current.linearGradient.fillEnabled()?(c=this.context.fillStyle,this.context.fillStyle=d,this.context.fill(),this.context.fillStyle=c):this.fillEnabled()&&this.context.fillRect(a.xmin,a.ymin,a.width,a.height),__not_null(d)&&this.__current.linearGradient.strokeEnabled()?(c=this.context.strokeStyle,this.context.strokeStyle=d,this.context.stroke(),this.context.strokeStyle=c):this.strokeEnabled()&&this.context.strokeRect(a.xmin,a.ymin,a.width,a.height),__not_null(this.__current.fillImage)&&this.context.drawImage(this.__current.fillImage,a.xmin,a.ymin,a.width,a.height),__not_empty(b)&&this.drawText(b,a);if(this.__selectable){var e=this.getRGBA();(this.fillEnabled()||this.linearGradientEnabled(0)||__not_null(this.__current.fillImage))&&x.fillRect(this.__bresenhamDC,a.xmin,a.ymin,a.xmax,a.ymax,e),(this.strokeEnabled()||this.linearGradientEnabled(1))&&x.strokeRect(this.__bresenhamDC,a.xmin,a.ymin,a.xmax,a.ymax,this.context.lineWidth,e)}},drawText:function(a,b){var c=this.context.measureText(a).width;while(c>b.width&&a.length>3)a=a.slice(0,a.length-3),a+="..",c=this.context.measureText(a).width;var d=this.context.fillStyle;this.context.fillStyle=this.__current.textStyle,this.context.textAlign==="left"?this.context.fillText(a,b.xmin,b.ymin):this.context.textAlign==="right"?this.context.fillText(a,b.xmax,b.ymin):this.context.fillText(a,(b.xmin+b.xmax)/2,b.ymin),this.context.fillStyle=d}},a.esri2.Common={},a.esri2.Common.ImageLoader=j,a.esri2.Common.PairArray=t,a.esri2.Common.RectType=v,a.esri2.Common.PointType=u,a.esri2.Map=l,a.esri2.Map.Layer=n,a.esri2.Map.Shape=q,a.esri2.Map.Point=o,a.esri2.Map.Render=p,a.esri2.Map.Bound=m,a.esri2.Map.Symbol=r})(window);;