/******************************************************************************
 * esri2.mapctl.js
 *
 * Version: 0.0.1pre
 *
 * Copyright (c) 2011-2012 Esri
 *
 * All rights reserved under the copyright laws of the United States.
 * You may freely redistribute and use this software, with or
 * without modification, provided you include the original copyright
 * and use restrictions.  See use restrictions in the file:
 * <install location>/License.txt
 *
 * Last Date: 
 *****************************************************************************//**
 * esri2.mapctl.js
 */
(function(a,b){__using_script(__get_script_path(a)+b)})("/esri2.mapctl.js","esri2.map.js"),function(a,b){function h(b,c){function N(a){var b=i.getAttribute("tileSizeX"),c=i.getAttribute("tileSizeY"),d=b*a.resolution,e=c*a.resolution,g=i.getDataBound(),h=i.getViewDataBound(),j=J(g,h,d,e,a.layer.getAttribute("numTilesX"),a.layer.getAttribute("numTilesY"));if(j.valid){var k=new esri2.Common.ImageLoader(function(b){var c=b.loader.param,d=b.param;L(a.layer,j),M(a.layer,b),c.refresh(!1,d),!b.loader.allReady()},i),l,m,n;for(l=j.xmin;l<j.xmax;l++)for(m=j.ymin;m<j.ymax;m++){n="/tile/"+a.level+"/"+m+"/"+l;var o=K(g,d,e,l,m),p=G.find(n);p===f?k.addImage(n,D+n,o):i.refresh(!1,o)}k.loadAll()}}function M(a,b){var c=G.find(b.name),d;if(c===f){d=a.addShape();var e=b.param;d.createRectXY(e.xmin,e.ymin,e.xmax,e.ymax),d.image=b.image,G.insert(b.name,d),a.updateBound()}else d=G.getVal(c),a.findShape(d)===-1&&(a.addShape(d),a.updateBound())}function L(a,b){if(G.size()>=F){var c=G.size(),d,e;while(c-->0){d=G.getKey(c),e=G.getVal(c);if(e.parent!==a){G.erase(d),e.parent.removeAt(e);if(G.size()<F)return}}if(G.size()<F)return;c=0;var f,g,h,i;while(G.size()>=F){if(c++===F){console.assert(!1&&"should never run to this");return}d=G.getKey(0),e=G.getVal(0),console.assert(e.parent===a),h=d.indexOf("/",6)+1,i=d.indexOf("/",h),f=d.substring(h,i),g=d.substr(i+1);if(f<b.xmin||f>=b.xmax||g<b.ymin||g>=b.ymax){G.erase(d),e.parent.removeAt(e);if(G.size()<F)return}}}}function K(a,b,c,d,e){return new esri2.Common.RectType(a.xmin+d*b,a.ymax-(e+1)*c,a.xmin+(d+1)*b,a.ymax-e*c)}function J(a,b,c,d,e,f){var g=Math.floor((b.xmin-a.xmin)/c)-1,h=Math.ceil((b.xmax-a.xmin)/c)+1,i=Math.floor((a.ymax-b.ymax)/d)-1,j=Math.ceil((a.ymax-b.ymin)/d)+1;g<0&&(g=0),i<0&&(i=0),h>e&&(h=e),j>f&&(j=f);return new esri2.Common.RectType(g,i,h,j)}function C(a){if(i){p&&q&&(p.value=a._x,q.value=a._y);if(t&&u){var b=i.toMapPoint(a._x,a._y);t.value=b.x,u.value=b.y}}}function B(a){return k.firefox&&a.layerY?a.layerY-m:a.offsetY}function A(a){return k.firefox&&a.layerX?a.layerX-l:a.offsetX}function z(){j=__get_elem(g),k=__get_browser();if(k.firefox||k.chrome)j.style.position!=="absolute"&&(h=!0);p=__get_elem(n),q=__get_elem(o),t=__get_elem(r),u=__get_elem(s),i=new esri2.Map(e),i.bkgndColor="#fff",i.resizeMap(j.offsetWidth,j.offsetHeight)}var d=this,e=b,g=c,h=!1,i=null,j=null,k=null,l=0,m=0,n="_pos_x",o="_pos_y",p=null,q=null,r="_map_x",s="_map_y",t=null,u=null,v=null,w=null,x=null,y=null;this.getMousePos=function(a){h&&(l=j.offsetLeft,m=j.offsetTop),a._x=A(a),a._y=B(a)},this.setMousePosSink=function(a,b,c,d){n=a,o=b,r=c,s=d},this.setOnBeforeLoad=function(a,b){w=b,v=a},this.setOnAfterLoad=function(a,b){x=a,y=b},this.getMapCanvas=function(){return i},__add_event(a,"load",function(){__not_null(v)&&v(w),d.onInit(),__not_null(x)&&x(y)});var D=this.imagesLib=null,E=0,F=256,G=new esri2.Common.PairArray,H=6370984.25867762,I=247.36950028266;this.posInCanvas=function(a,b){return a>0&&a<i.width&&(b>0&&b<i.height)},this.onMouseWheel=function(a){this.getMousePos(a);var b=a._x,c=a._y;__log(b,c);if(this.posInCanvas(b,c)){a.preventDefault(),a.stopPropagation();if(__is_null(i.getAttribute("totalLevels")))return;a.detail===-3?E=d.zoomLevel(++E,b,c):a.detail===3&&(E=d.zoomLevel(--E,b,c))}},this.onInit=function(){z(),i.onMouseClick=function(a,b){d.getMousePos(a)},i.onMouseDblClick=function(a,b){d.getMousePos(a)},i.onMouseDown=function(a,b){d.getMousePos(a),b.setCursor("move",a),b.addAttribute("_pan_map",!1),b.addAttribute("_lbtn_down",!0),b.addAttribute("_pos_x",a._x),b.addAttribute("_pos_y",a._y),__is_null(b.fastHitTest(a._x,a._y,a))&&(b.addAttribute("_pan_map",!0),b.addAttribute("_pan_shape",null))},i.onMouseUp=function(a,b){d.getMousePos(a),b.addAttribute("_lbtn_down",!1),b.setCursor("default");var c=b.addAttribute("_pan_shape",null);if(__not_null(c)){var e=b.addAttribute("_pan_shape_layer",null);b.trackingLayer.removeAt(c),e.addShape(c),e.updateBound(),b.refresh(!0,c)}else if(b.getAttribute("_pan_map")){b.addAttribute("_pan_map",!1);var f=b.getAttribute("_pos_x"),g=b.getAttribute("_pos_y");b.panView(f,g,a._x,a._y);var h=b.getAttribute("level:"+E);__not_null(h)&&N(h)}},i.onMouseMove=function(a,b){d.getMousePos(a),C(a);var c,e,f=b.getAttribute("_pan_shape");if(__not_null(f)){c=b.getAttribute("_pos_x"),e=b.getAttribute("_pos_y"),b.addAttribute("_pos_x",a._x),b.addAttribute("_pos_y",a._y);var g=b.toMapPoint(c,e),h=b.toMapPoint(a._x,a._y);f.offset(h.x-g.x,h.y-g.y),b.trackingLayer.updateBound(),b.refreshTrackingLayer(f)}else b.getAttribute("_pan_map")?(d.opState="",c=b.getAttribute("_pos_x"),e=b.getAttribute("_pos_y"),b.addAttribute("_pos_x",a._x),b.addAttribute("_pos_y",a._y),b.panView(c,e,a._x,a._y),b.refresh(!1)):__is_null(b.fastHitTest(a._x,a._y,a))&&b.setCursor("default")},i.onMouseWheel=function(a,b){a.preventDefault(),a.stopPropagation();__is_null(b.getAttribute("totalLevels"))||(d.getMousePos(a),__log(a.type),a.wheelDelta>0?E=d.zoomLevel(++E,a._x,a._y):a.wheelDelta<0&&(E=d.zoomLevel(--E,a._x,a._y)))}},this.addMapService=function(a){D=a.url;var b=a.data,c=b.tileInfo,e=c.rows,f=c.cols,g=c.dpi,h=c.origin.x,j=c.origin.y,k=c.lods,l=b.fullExtent,m=l.spatialReference.wkid,n=H*I,o=H*I*.5;i.addAttribute("spatialReference",m),i.addAttribute("earthRadius",H),i.addAttribute("fullExtent",l),i.addAttribute("fullWidthIn",n),i.addAttribute("fullHeightIn",o),i.addAttribute("tileSizeX",e),i.addAttribute("tileSizeY",f),i.addAttribute("totalLevels",k.length);var p=0,q,r,s,t,u;for(q in k)r=k[q],s=Number(n/r.scale*g/f+.1).toFixed(0),t=Number(o/r.scale*g/e+.1).toFixed(0),u=i.addLayer("level:"+p,"tiles: ",s,t),u.addAttribute("numTilesX",s),u.addAttribute("numTilesY",t),r.layer=u,i.addAttribute("level:"+p,r),++p;i.updateBound(l),i.zoomAll();var v=i.dataBound.rect,w=v.center;i.centerAt(w.x,w.y);var x=i.toViewPos(w.x,w.y);E=d.zoomLevel(0,x.x,x.y)},this.zoomLevel=function(a,b,c){if(a<0)return 0;var d=i.getAttribute("totalLevels");if(a>=d)return d-1;var e,f;for(e=0;e<d;e++)f=i.getAttribute("level:"+e),f.layer.visible=e===a;f=i.getAttribute("level:"+a);var g=i.toMapPoint(b,c);i.zoomResolution(f.resolution);var h=i.toViewPos(g.x,g.y);i.panView(h.x,h.y,b,c),N(f);return a}}function g(a,b){this.url=a,this.data=b,this.toString=function(){return"AgisMapService"},this.__maxCachedTiles=256,this.__cachedTiles=new esri2.Common.PairArray,this.__earthRadius=6370984.25867762,this.__inchFactor=247.36950028266}"use strict";var c=!0,d=!1,e=null,f=-1;a.esri2.MapCtl=h,a.esri2.MapCtl.AgisMapService=g}(window);;